name: Build & Deploy to Production Server

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Baue das Plugin (hier Gradle, passe den Befehl ggf. an)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Build with Gradle
        run: ./gradlew build

      # Prepare JAR files for deployment (flatten directory structure)
      - name: Prepare plugin files
        run: |
          mkdir -p deploy-staging
          cp build/libs/*.jar deploy-staging/

      # Kopiere das gebaute JAR auf den Server
      - name: Copy plugin to Challenge Server via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          source: deploy-staging/*.jar
          target: /var/lib/pterodactyl/volumes/f5f577cd-0b22-4b2f-ae90-fb23cc1b2a15/plugins/

      # Führe den reload-Befehl über die Pterodactyl API aus
      - name: Reload Bukkit Server via Pterodactyl API
        run: |
          curl -X POST "${{ secrets.PTERO_PANEL_URL }}/api/client/servers/${{ secrets.PTERO_SERVER_ID }}/command" \
            -H "Authorization: Bearer ${{ secrets.PTERO_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"command":"bukkit:reload confirm"}'
